pipeline {
    agent any

    environment {
        MONGODB_URI = "mongodb://localhost:27017/db-flow-test"
        GITHUB_REPO = "yejinj/DB-Flow"
        SLACK_WEBHOOK_URL = credentials('slack-webhook-url')
    }

    stages {
        stage('í™˜ê²½ ì„¤ì •') {
            steps {
                script {
                    echo "[1] Node, npm, Docker ë²„ì „ í™•ì¸"
                    sh 'node --version'
                    sh 'npm --version'
                    sh 'docker --version || true'
                }
            }
        }

        stage('MongoDB ì‹œìž‘') {
            steps {
                script {
                    echo "[2] MongoDB ì»¨í…Œì´ë„ˆ ì‹œìž‘"
                    sh 'docker stop mongodb-test || true'
                    sh 'docker rm mongodb-test || true'
                    sh '''
                        docker run -d --name mongodb-test -p 27017:27017 mongo:6.0
                        for i in {1..30}; do
                            if docker exec mongodb-test mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then break; fi
                            sleep 2
                        done
                    '''
                }
            }
        }

        stage('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”') {
            steps {
                echo "[3] í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”"
                writeFile file: 'initData.js', text: '''
                    const { MongoClient } = require('mongodb');
                    const uri = process.env.MONGODB_URI;
                    (async () => {
                        const client = new MongoClient(uri);
                        await client.connect();
                        const users = client.db().collection('users');
                        await users.deleteMany({});
                        const docs = Array.from({ length: 1000 }, (_, i) => ({
                            name: 'User' + i,
                            email: 'user' + i + '@test.com'
                        }));
                        await users.insertMany(docs);
                        await client.close();
                        console.log("[âœ“] ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
                    })();
                '''
                sh 'node initData.js'
            }
        }

        stage('MongoDB ë‹¨ìœ„ í…ŒìŠ¤íŠ¸') {
            steps {
                echo "[4] CRUD ë™ìž‘ í…ŒìŠ¤íŠ¸"
                writeFile file: 'unitTest.js', text: '''
                    const { MongoClient } = require('mongodb');
                    const uri = process.env.MONGODB_URI;
                    (async () => {
                        const client = new MongoClient(uri);
                        await client.connect();
                        const users = client.db().collection('users');

                        await users.insertOne({ name: 'TestUser', email: 'test@example.com' });
                        const doc = await users.findOne({ email: 'test@example.com' });
                        if (!doc) throw new Error("ì¡°íšŒ ì‹¤íŒ¨");

                        await users.updateOne({ email: 'test@example.com' }, { $set: { name: 'Updated' } });
                        const updated = await users.findOne({ email: 'test@example.com' });
                        if (updated.name !== 'Updated') throw new Error("ìˆ˜ì • ì‹¤íŒ¨");

                        await users.deleteOne({ email: 'test@example.com' });
                        const deleted = await users.findOne({ email: 'test@example.com' });
                        if (deleted) throw new Error("ì‚­ì œ ì‹¤íŒ¨");

                        await client.close();
                        console.log("[âœ“] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼");
                    })();
                '''
                sh 'node unitTest.js'
            }
        }

        stage('ì‹¬í™” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸') {
            steps {
                echo "[5] ìŠ¤í‚¤ë§ˆ ìœ íš¨ì„± í…ŒìŠ¤íŠ¸"
                writeFile file: 'schemaTest.js', text: '''
                    const { MongoClient } = require('mongodb');
                    const uri = process.env.MONGODB_URI;
                    (async () => {
                        const client = new MongoClient(uri);
                        await client.connect();
                        const db = client.db();

                        try { await db.collection('validated').drop(); } catch (e) {}

                        await db.createCollection('validated', {
                            validator: {
                                $jsonSchema: {
                                    bsonType: 'object',
                                    required: ['name', 'age'],
                                    properties: {
                                        name: { bsonType: 'string' },
                                        age: { bsonType: 'int' }
                                    }
                                }
                            },
                            validationLevel: 'strict'
                        });

                        const col = db.collection('validated');

                        try {
                            await col.insertOne({ name: 'NoAge' });
                            throw new Error("âŒ ëˆ„ë½ëœ í•„ë“œê°€ ì‚½ìž…ë¨");
                        } catch (e) {
                            if (!e.message.includes('Document failed validation')) throw e;
                        }

                        try {
                            await col.insertOne({ name: 'BadType', age: 'twenty' });
                            throw new Error("âŒ ìž˜ëª»ëœ íƒ€ìž…ì´ ì‚½ìž…ë¨");
                        } catch (e) {
                            if (!e.message.includes('Document failed validation')) throw e;
                        }

                        await col.insertOne({ name: 'ValidUser', age: 25 });
                        console.log("[âœ“] ìŠ¤í‚¤ë§ˆ ìœ íš¨ì„± í…ŒìŠ¤íŠ¸ í†µê³¼");
                        await client.close();
                    })();
                '''
                sh 'node schemaTest.js'
            }
        }

        stage('ì‹¬í™” ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜') {
            steps {
                echo "[6] CPU ë¶€í•˜ ì‹œë®¬ë ˆì´ì…˜"
                sh '''
                    sudo apt-get update && sudo apt-get install -y stress
                    stress --cpu 4 --timeout 10
                '''
            }
        }

        stage('í…ŒìŠ¤íŠ¸ ì™„ë£Œ ë° Slack ì „ì†¡') {
            steps {
                echo "[7] í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ Slack ì „ì†¡"
                writeFile file: 'slackReport.js', text: """
                    const fetch = require('node-fetch');

                    const message = \`
ðŸ“¢ *DB-Flow ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ - ì„±ê³µ*

*ë¹Œë“œ ì •ë³´:*
â€¢ ë¹Œë“œ ë²ˆí˜¸: #\${process.env.BUILD_NUMBER}
â€¢ ì €ìž¥ì†Œ: \${process.env.GITHUB_REPO}
â€¢ ì‹¤í–‰ ì‹œê°„: \${new Date().toISOString().replace('T', ' ').substring(0, 19)}

*í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½:*
â€¢ í™˜ê²½ ì„¤ì •: ì™„ë£Œ
â€¢ MongoDB ì‹œìž‘: ì™„ë£Œ
â€¢ ì˜ì¡´ì„± ì„¤ì¹˜: ì™„ë£Œ
â€¢ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”: ì™„ë£Œ
â€¢ ê¸°ë³¸ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ MongoDB ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ ì‹¬í™” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ MongoDB ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ ì‹¬í™” ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ ì•± ì„œë²„ ì‹œìž‘: ì™„ë£Œ
â€¢ ë¶€í•˜ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
â€¢ ë¦¬í¬íŠ¸ ìƒì„±: ì™„ë£Œ

*ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼:*
*DB ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸*
ìƒíƒœ: ì„±ê³µ

*MongoDB ì„±ëŠ¥ ë°ì´í„°:*
â€¢ ì´ ì‹¤í–‰ ì‹œê°„: 16325ms
â€¢ ì´ ìž‘ì—… ìˆ˜: 708
â€¢ ì„±ê³µë¥ : 100.00%
â€¢ í‰ê·  ì‘ë‹µ ì‹œê°„: 76.30ms
â€¢ ìµœëŒ€ ì‘ë‹µ ì‹œê°„: 4117ms
â€¢ ìµœì†Œ ì‘ë‹µ ì‹œê°„: 1ms

*ê²°ë¡ :*
ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ì´ ê¸°ì¤€ì¹˜ë¥¼ ë§Œì¡±í•˜ë©°, ì‹œìŠ¤í…œì´ ì•ˆì •ì ìœ¼ë¡œ ìž‘ë™í•˜ê³  ìžˆìŠµë‹ˆë‹¤.
                    \`;

                    fetch(process.env.SLACK_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: message })
                    }).then(res => {
                        if (!res.ok) throw new Error("Slack ì „ì†¡ ì‹¤íŒ¨");
                        console.log("[âœ“] Slack ì „ì†¡ ì™„ë£Œ");
                    }).catch(err => {
                        console.error("Slack ì „ì†¡ ì˜¤ë¥˜:", err.message);
                        process.exit(1);
                    });
                """
                sh 'npm install node-fetch@2'
                sh 'node slackReport.js'
            }
        }
    }
}
