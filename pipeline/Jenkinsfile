pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        GITHUB_REPO = "yejinj/DB-Flow"
        DOCKER_REGISTRY = "docker.io/yejinj"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[$class: 'CleanBeforeCheckout']], // 체크아웃 전 정리
                    userRemoteConfigs: [[
                        url: "https://github.com/${env.GITHUB_REPO}.git"
                    ]]
                ])
                echo "코드 체크아웃 완료"
            }
        } 
        
        stage('Setup Environment') {
            steps {
                script {
                    // Node.js 설치 확인
                    sh 'node --version'
                    sh 'npm --version'
                    
                    // Docker 설치 확인
                    sh 'docker --version'
                    sh 'docker-compose --version'
                }
            }
        }
        
        stage('Build Docker Containers') {
            steps {
                dir('app') {  // app 디렉토리 내에서 실행
                    script {
                        def packageJson = readJSON file: 'package.json'
                        docker.build("db-flow-app", ".")
                    }
                }
            }
        }
        
        stage('Start MongoDB Replica Set') {
            steps {
                dir('database') {
                    sh 'docker-compose up -d'
                    // MongoDB 복제본 셋 초기화 대기
                    sh 'sleep 30'
                }
            }
        }
        
        stage('Run Database Tests') {
            steps {
                dir('tests') {
                    sh 'npm install'
                    sh 'npm test'
                }
            }
        }
        
        stage('Performance Tests') {
            steps {
                dir('tests') {
                    sh 'npm install -g artillery'
                    sh 'artillery run performance/load-test.yml'
                }
            }
        }
    } 

    post {
        always {
            script {
                // MongoDB 컨테이너 정리
                dir('database') {
                    sh 'docker-compose down'
                }
                
                echo "빌드 종료 - 상태: ${currentBuild.result ?: '성공'}"
            }
        } 

        success {
            script {
                try {
                    def message = "*DB-Flow 빌드 #${BUILD_NUMBER} 성공!*" +
                                 "\n- 저장소: ${env.GITHUB_REPO}" +
                                 "\n- 빌드 URL: ${env.BUILD_URL}"

                    withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_URL')]) {
                        sh """
                        curl -X POST -H 'Content-type: application/json' \
                          --data '{"text":"${message}"}' \
                          "${SLACK_URL}"
                        """
                    }
                } catch (Exception e) {
                    echo "Slack 알림 실패: ${e.message}"
                }
            }
        }

        failure {
            script {
                try {
                    withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_URL')]) {
                        sh """
                        curl -X POST -H 'Content-type: application/json' \
                          --data '{"text":"DB-Flow 빌드 #${BUILD_NUMBER} 실패\\n- 콘솔 출력: ${env.BUILD_URL}console"}' \
                          "${SLACK_URL}"
                        """
                    }
                } catch (Exception e) {
                    echo "Slack 알림 실패: ${e.message}"
                }
            }
        }
    }
}
